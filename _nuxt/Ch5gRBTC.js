import{H as A,P as g,U as y,ak as w,a2 as P,az as N}from"./DFMj1dpU.js";const h=()=>({firstName:"",lastName:"",phone:"",email:""}),v=(l="")=>{if(!l)return{firstName:"",lastName:""};const p=l.trim().split(/\s+/),[i="",...n]=p;return{firstName:i,lastName:n.join(" ")}},b=A("userProfile",{state:()=>({profile:h(),isLoading:!1,isSaving:!1,error:null,lastSavedAt:null,hasExistingProfile:!1}),actions:{resetProfile(){this.profile=h(),this.error=null,this.lastSavedAt=null,this.hasExistingProfile=!1},async loadProfile(l=null){var f,m,e,a;const p=g(),{auth:i,firebaseDatabase:n}=p.$firebase||{},c=l?{uid:l}:i==null?void 0:i.currentUser;if(!(c!=null&&c.uid)||!n){this.resetProfile();return}this.isLoading=!0,this.error=null;try{const r=y(n,"userProfiles",c.uid),t=await N(r);if(t.exists()){const s=t.data()||{},o={...h(),...s};this.profile=o,this.hasExistingProfile=!0;const u=(m=(f=s.updatedAt)==null?void 0:f.toDate)==null?void 0:m.call(f),d=(a=(e=s.createdAt)==null?void 0:e.toDate)==null?void 0:a.call(e);this.lastSavedAt=u||d||null}else{const s=i==null?void 0:i.currentUser,o=(s==null?void 0:s.email)||"",{firstName:u,lastName:d}=v((s==null?void 0:s.displayName)||"");this.profile={...h(),firstName:u,lastName:d,email:o},this.hasExistingProfile=!1,this.lastSavedAt=null}}catch(r){throw console.error("Failed to load profile",r),this.error=(r==null?void 0:r.message)||"Unable to load your profile right now.",r}finally{this.isLoading=!1}},async saveProfile(l={}){const i=g().$firebase||{},{auth:n,firebaseDatabase:c,updateProfile:f,updateEmail:m}=i,e=n==null?void 0:n.currentUser;if(!(e!=null&&e.uid)||!c){const t=new Error("You must be logged in to save your profile.");throw this.error=t.message,t}this.isSaving=!0,this.error=null;const a={...h(),...this.profile,...l,email:l.email??this.profile.email??e.email??""},r={...a,updatedAt:P()};this.hasExistingProfile||(r.createdAt=P());try{const t=y(c,"userProfiles",e.uid);await w(t,r,{merge:!0});const s=[a.firstName,a.lastName].filter(Boolean).join(" ").trim();if(s)try{await(f==null?void 0:f(e,{displayName:s}))}catch(o){console.warn("Unable to update display name",o)}if(a.email&&e.email&&a.email!==e.email&&typeof m=="function")try{await m(e,a.email)}catch(o){console.warn("Unable to update authentication email",o),this.error=this.error||(o==null?void 0:o.message)||"Unable to update email address."}this.profile=a,this.hasExistingProfile=!0,this.lastSavedAt=new Date}catch(t){throw console.error("Failed to save profile",t),this.error=(t==null?void 0:t.message)||"Unable to save your profile right now.",t}finally{this.isSaving=!1}}}});export{b as u};
